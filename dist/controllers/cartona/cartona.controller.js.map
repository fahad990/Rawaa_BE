{"version":3,"sources":["../../../src/controllers/cartona/cartona.controller.js"],"names":["validateBody","isUpdate","exists","withMessage","createCartona","req","res","next","validationErrors","array","length","user","type","findById","id","userDetails","file","body","img","_id","create","newDoc","status","json","allCartones","limit","parseInt","query","page","typeOfSize","count","docsCount","find","populate","skip","sort","creationDate","allDocs","send","Math","ceil","updateCartona","cartonId","params","carton","update","$set","numberOfBottles","sizeOfBottles","price","minimumNumberOnOrder","newCartonw","cartonDetails","end","cartonsOfOneProvider","userId","updateAvalaibiltyOfCarton","available","save"],"mappings":"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","file":"cartona.controller.js","sourcesContent":["import Cartona from '../../models/cartona.model';\nimport mongoose from 'mongoose';\nimport { body, validationResult } from 'express-validator/check';\nimport { toImgUrl } from '../../utils/index'\nimport ApiError from '../../helpers/ApiError'\nimport ApiResponse from '../../helpers/ApiResponse'\nimport User from '../../models/user.model'\n\nexport default {\n    validateBody(isUpdate = false) {\n        return [\n            body(\"numberOfBottles\").exists().withMessage(\"numberOfBottles is required\"),\n            body(\"sizeOfBottles\").exists().withMessage(\"sizeOfBottles is required\"),\n            // body(\"img\").exists().withMessage(\"img is required\"),\n            body(\"price\").exists().withMessage(\"price is required\"),\n        ];\n    },\n    //create new cartona product\n    async createCartona(req, res, next) {\n        const validationErrors = validationResult(req).array();\n        if (validationErrors.length > 0)\n            return next(new ApiError(422, validationErrors));\n        try {\n            if (!(req.user.type == \"PROVIDER\")) {\n                next(new ApiError(403, 'not provider user'))\n            }\n            let userDetails = await User.findById(req.user.id);\n            if (req.file) {\n                req.body.img = await toImgUrl(req.file)\n            } else {\n                next(new ApiError(422, 'img is required'))\n            }\n            req.body.user = req.user._id\n            let newDoc = await Cartona.create(req.body);\n            return res.status(201).json(newDoc);\n        } catch (err) {\n            next(err)\n        }\n    },\n    //retrive all cartona products \n    async allCartones(req, res, next) {\n        const limit = parseInt(req.query.limit) || 20;\n        const page = req.query.page || 1;\n        let query = {}\n        if (req.query.typeOfSize)\n            query.typeOfSize = req.query.typeOfSize\n        try {\n            let docsCount = await Cartona.count(query)\n            let allDocs = await Cartona.find(query).populate('user')\n                .skip((page - 1) * limit).limit(limit)\n                .sort({ creationDate: -1 })\n            return res.send(new ApiResponse(\n                allDocs,\n                page,\n                Math.ceil(docsCount / limit),\n                limit,\n                docsCount,\n                req\n            ))\n        } catch (err) {\n            next(err)\n        }\n    },\n    //update cartone\n    async updateCartona(req, res, next) {\n        const cartonId = req.params.cartonId;\n        try {\n            let carton = await Cartona.findById(cartonId)\n            if (!(req.user.id == carton.user)) {\n                return next(new ApiError(403, \"not have access to this resourse\"))\n            }\n\n            if (req.file) {\n                req.body.img = await toImgUrl(req.file)\n            }\n            await Cartona.update({ _id: cartonId }, {\n                $set: {\n                    numberOfBottles: req.body.numberOfBottles || carton.numberOfBottles,\n                    sizeOfBottles: req.body.sizeOfBottles || carton.sizeOfBottles,\n                    typeOfSize: req.body.typeOfSize || carton.typeOfSize,\n                    price: req.body.price || carton.price,\n                    img: req.body.img || carton.img,\n                    minimumNumberOnOrder: req.body.minimumNumberOnOrder || carton.minimumNumberOnOrder,\n                }\n            })\n            let newCartonw = await Cartona.findById(carton)\n                .populate('user')\n            return res.status(200).json(newCartonw)\n        } catch (err) {\n            next(err)\n        }\n    },\n\n    //retrive one cartone details \n    async cartonDetails(req, res, next) {\n        try {\n            if (!req.params.cartonId)\n                next(new ApiError(422, \"missed cartonId\"))\n            const cartonId = req.params.cartonId;\n            let carton = await Cartona.findById(cartonId).populate('user')\n            if (!carton) {\n                return res.status(404).end();\n            }\n            return res.status(200).json(carton)\n        } catch (err) {\n            next\n        }\n    },\n    //retrive all galons under one provider \n    async cartonsOfOneProvider(req, res, next) {\n        const limit = parseInt(req.query.limit) || 20;\n        const page = req.query.page || 1;\n        const userId = req.params.userId;\n        try {\n            let docsCount = await Cartona.count({ user: userId })\n            let allDocs = await Cartona.find({ user: userId })\n                .populate('user')\n                .skip((page - 1) * limit).limit(limit).sort({ creationDate: -1 })\n            return res.send(new ApiResponse(\n                allDocs,\n                page,\n                Math.ceil(docsCount / limit),\n                limit,\n                docsCount,\n                req\n            ))\n        } catch (err) {\n            next(err)\n        }\n    },\n    //make carttons available\n    async updateAvalaibiltyOfCarton(req, res, next) {\n        try {\n            let cartonId = req.params.cartonId;\n            let cartonDetails = await Cartona.findById(cartonId);\n            if (!cartonDetails)\n                return res.status(404).end();\n\n            if (cartonDetails.available == true)\n                cartonDetails.available = false\n            else\n                cartonDetails.available = true\n\n            await cartonDetails.save();\n            return res.status(204).end();\n        } catch (err) {\n            next(err)\n        }\n    },\n\n}\n"]}