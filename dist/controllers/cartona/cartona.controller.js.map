{"version":3,"sources":["../../../src/controllers/cartona/cartona.controller.js"],"names":["validateBody","isUpdate","exists","withMessage","createCartona","req","res","next","validationErrors","array","length","user","type","findById","id","userDetails","file","body","img","_id","create","newDoc","status","json","allCartones","limit","parseInt","query","page","typeOfSize","available","count","docsCount","find","populate","skip","sort","creationDate","allDocs","send","Math","ceil","updateCartona","cartonId","params","carton","update","$set","numberOfBottles","sizeOfBottles","price","minimumNumberOnOrder","newCartonw","cartonDetails","end","cartonsOfOneProvider","userId","updateAvalaibiltyOfCarton","save"],"mappings":"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","file":"cartona.controller.js","sourcesContent":["import Cartona from '../../models/cartona.model';\r\nimport mongoose from 'mongoose';\r\nimport { body, validationResult } from 'express-validator/check';\r\nimport { toImgUrl } from '../../utils/index'\r\nimport ApiError from '../../helpers/ApiError'\r\nimport ApiResponse from '../../helpers/ApiResponse'\r\nimport User from '../../models/user.model'\r\n\r\nexport default {\r\n    validateBody(isUpdate = false) {\r\n        return [\r\n            body(\"numberOfBottles\").exists().withMessage(\"numberOfBottles is required\"),\r\n            body(\"sizeOfBottles\").exists().withMessage(\"sizeOfBottles is required\"),\r\n            // body(\"img\").exists().withMessage(\"img is required\"),\r\n            body(\"price\").exists().withMessage(\"price is required\"),\r\n        ];\r\n    },\r\n    //create new cartona product\r\n    async createCartona(req, res, next) {\r\n        const validationErrors = validationResult(req).array();\r\n        if (validationErrors.length > 0)\r\n            return next(new ApiError(422, validationErrors));\r\n        try {\r\n            if (!(req.user.type == \"PROVIDER\")) {\r\n                next(new ApiError(403, 'not provider user'))\r\n            }\r\n            let userDetails = await User.findById(req.user.id);\r\n            if (req.file) {\r\n                req.body.img = await toImgUrl(req.file)\r\n            } else {\r\n                next(new ApiError(422, 'img is required'))\r\n            }\r\n            req.body.user = req.user._id\r\n            let newDoc = await Cartona.create(req.body);\r\n            return res.status(201).json(newDoc);\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n    //retrive all cartona products \r\n    async allCartones(req, res, next) {\r\n        const limit = parseInt(req.query.limit) || 20;\r\n        const page = req.query.page || 1;\r\n        let query = {}\r\n        if (req.query.typeOfSize)\r\n            query.typeOfSize = req.query.typeOfSize\r\n        query.available = true\r\n        try {\r\n            let docsCount = await Cartona.count(query)\r\n            let allDocs = await Cartona.find(query).populate('user')\r\n                .skip((page - 1) * limit).limit(limit)\r\n                .sort({ creationDate: -1 })\r\n            return res.send(new ApiResponse(\r\n                allDocs,\r\n                page,\r\n                Math.ceil(docsCount / limit),\r\n                limit,\r\n                docsCount,\r\n                req\r\n            ))\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n    //update cartone\r\n    async updateCartona(req, res, next) {\r\n        const cartonId = req.params.cartonId;\r\n        try {\r\n            let carton = await Cartona.findById(cartonId)\r\n            if (!(req.user.id == carton.user)) {\r\n                return next(new ApiError(403, \"not have access to this resourse\"))\r\n            }\r\n\r\n            if (req.file) {\r\n                req.body.img = await toImgUrl(req.file)\r\n            }\r\n            await Cartona.update({ _id: cartonId }, {\r\n                $set: {\r\n                    numberOfBottles: req.body.numberOfBottles || carton.numberOfBottles,\r\n                    sizeOfBottles: req.body.sizeOfBottles || carton.sizeOfBottles,\r\n                    typeOfSize: req.body.typeOfSize || carton.typeOfSize,\r\n                    price: req.body.price || carton.price,\r\n                    available: req.body.available || carton.available,\r\n                    img: req.body.img || carton.img,\r\n                    minimumNumberOnOrder: req.body.minimumNumberOnOrder || carton.minimumNumberOnOrder,\r\n                }\r\n            })\r\n            let newCartonw = await Cartona.findById(carton)\r\n                .populate('user')\r\n            return res.status(200).json(newCartonw)\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n\r\n    //retrive one cartone details \r\n    async cartonDetails(req, res, next) {\r\n        try {\r\n            if (!req.params.cartonId)\r\n                next(new ApiError(422, \"missed cartonId\"))\r\n            const cartonId = req.params.cartonId;\r\n            let carton = await Cartona.findById(cartonId).populate('user')\r\n            if (!carton) {\r\n                return res.status(404).end();\r\n            }\r\n            return res.status(200).json(carton)\r\n        } catch (err) {\r\n            next\r\n        }\r\n    },\r\n    //retrive all galons under one provider \r\n    async cartonsOfOneProvider(req, res, next) {\r\n        const limit = parseInt(req.query.limit) || 200;\r\n        const page = req.query.page || 1;\r\n        const userId = req.params.userId;\r\n        try {\r\n            let query = {}\r\n            query.available = true\r\n            query.user = userId\r\n            let docsCount = await Cartona.count(query)\r\n            let allDocs = await Cartona.find(query)\r\n                .populate('user')\r\n                .skip((page - 1) * limit).limit(limit).sort({ creationDate: -1 })\r\n            return res.send(new ApiResponse(\r\n                allDocs,\r\n                page,\r\n                Math.ceil(docsCount / limit),\r\n                limit,\r\n                docsCount,\r\n                req\r\n            ))\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n    //make carttons available\r\n    async updateAvalaibiltyOfCarton(req, res, next) {\r\n        try {\r\n            let cartonId = req.params.cartonId;\r\n            let cartonDetails = await Cartona.findById(cartonId);\r\n            if (!cartonDetails)\r\n                return res.status(404).end();\r\n\r\n            if (cartonDetails.available == true)\r\n                cartonDetails.available = false\r\n            else\r\n                cartonDetails.available = true\r\n\r\n            await cartonDetails.save();\r\n            return res.status(204).end();\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n\r\n}\r\n"]}