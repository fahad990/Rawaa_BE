{"version":3,"sources":["../../src/controllers/order.controller.js"],"names":["deg2rad","deg","Math","PI","validateBody","isUpdate","exists","withMessage","createOrder","req","res","next","validationErrors","array","length","objectToCreated","body","cartons","cartonsArray","cartonsQuantity","x","push","id","quantity","galons","galonsArray","galonsQuantityOfBuying","galonsQuantityOfSubstitution","galonsType","z","quantityOfBuying","quantityOfSubstitution","typeOrder","lang","lat","orderLocation","location","provider","customer","user","price","deliveryPrice","create","newOrder","targetUser","order","text","newNoti","title","findById","populate","retriveOrder","lenOfCartons","result","resultcartons","resultcartonsQuantity","item","quantityItem","lenOfGalons","resultGalons","resultGalonsQuantityOfBuying","resultGalonsQuantityOfSubstitution","resultGalonsTypeOrder","galonsTypeOrder","typeOrderOfSubstitution","status","creationDate","json","allOrdersOfProvider","limit","parseInt","query","page","params","providerId","find","skip","sort","allOrders","map","OneOrderItem","cartonsResult","elme","oneCartonItem","galonsResult","oneGalonsItem","QuantityOfBuying","QuantityOfSubstitution","send","ceil","validateBodyOfCalulatePrice","calculatePriceOfDistance","lang1","parseFloat","from","lat1","lang2","to","lat2","R","dLat","dLon","a","sin","cos","c","atan2","sqrt","d","console","log","findOne","cost","orderDetails","orderId","end","acceptOrder","findByIdAndUpdate","new","refuseOrder","makeOrderOnDiliver","makeOrderDone","sendReasoneOfRefuseOrder","note","save","canceleOrder"],"mappings":"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","file":"order.controller.js","sourcesContent":["import Order from '../models/order.model'\r\nimport mongoose from 'mongoose';\r\nimport { body, validationResult } from 'express-validator/check';\r\nimport ApiError from '../helpers/ApiError';\r\nimport ApiResponse from '../helpers/ApiResponse';\r\nimport Price from '../models/price-of-km.model';\r\nimport { send } from '../services/push-notifications';\r\nimport NotificationOrder from '../models/notification.model';\r\n\r\n\r\nlet deg2rad = (deg) => {\r\n    return deg * (Math.PI / 180)\r\n}\r\nexport default {\r\n\r\n    validateBody(isUpdate = false) {\r\n        return [\r\n            body(\"price\").exists().withMessage(\"price is required\"),\r\n            body(\"provider\").exists().withMessage(\"provider is required\"),\r\n        ];\r\n    },\r\n    //create new order \r\n    async createOrder(req, res, next) {\r\n        try {\r\n            const validationErrors = validationResult(req).array();\r\n            if (validationErrors.length > 0)\r\n                return next(new ApiError(422, validationErrors));\r\n            let objectToCreated = {}\r\n            //prepare carton data [[{id : 5, quantity : 8}]]\r\n            if (req.body.cartons) {\r\n                let cartonsArray = req.body.cartons;\r\n                let cartons = [];\r\n                let cartonsQuantity = [];\r\n                for (let x = 0; x < cartonsArray.length; x++) {\r\n                    cartons.push(cartonsArray[x].id);\r\n                    cartonsQuantity.push(cartonsArray[x].quantity);\r\n                }\r\n                objectToCreated.cartons = cartons;\r\n                objectToCreated.cartonsQuantity = cartonsQuantity\r\n            }\r\n\r\n            //prepare galons data \r\n            if (req.body.galons) {\r\n                let galonsArray = req.body.galons;\r\n                let galons = [];\r\n                let galonsQuantityOfBuying = [];\r\n                let galonsQuantityOfSubstitution = [];\r\n                let galonsType = [];\r\n                for (let z = 0; z < galonsArray.length; z++) {\r\n                    galons.push(galonsArray[z].id);\r\n                    galonsQuantityOfBuying.push(galonsArray[z].quantityOfBuying);\r\n                    galonsQuantityOfSubstitution.push(galonsArray[z].quantityOfSubstitution);\r\n                    galonsType.push(galonsArray[z].typeOrder)\r\n                }\r\n                objectToCreated.galons = galons;\r\n                objectToCreated.galonsQuantityOfBuying = galonsQuantityOfBuying;\r\n                objectToCreated.galonsQuantityOfSubstitution = galonsQuantityOfSubstitution;\r\n            }\r\n            //prepare location \r\n            let lang = req.body.lang;\r\n            let lat = req.body.lat;\r\n            let orderLocation = [lang, lat];\r\n            objectToCreated.location = orderLocation\r\n            objectToCreated.provider = req.body.provider;\r\n            objectToCreated.customer = req.user.id;\r\n            objectToCreated.price = req.body.price;\r\n            objectToCreated.deliveryPrice = req.body.deliveryPrice;\r\n            let newOrder = await Order.create(objectToCreated);\r\n\r\n            //in app notification \r\n            let newNoti = await NotificationOrder.create({\r\n                targetUser: newOrder.provider,\r\n                order: newOrder,\r\n                text: 'لديك طلب جديد',\r\n            });\r\n\r\n            //send notifications\r\n            let title = \"لديك طلب جديد\";\r\n            let body = \"new Order\"\r\n            send(newOrder.provider, title, body)\r\n\r\n\r\n            //prepare response    \r\n            let retriveOrder = await Order.findById(newOrder.id)\r\n                .populate('cartons')\r\n                .populate('galons')\r\n                .populate('customer')\r\n                .populate('provider')\r\n            let lenOfCartons = await retriveOrder.cartons.length;\r\n            let result = {};\r\n            result.cartons = []\r\n            //prepare cartons \r\n            let resultcartons = retriveOrder.cartons;\r\n            let resultcartonsQuantity = retriveOrder.cartonsQuantity;\r\n            for (let x = 0; x < lenOfCartons; x++) {\r\n                let item = resultcartons[x];\r\n                let quantityItem = resultcartonsQuantity[x];\r\n                result.cartons.push({ \"item\": item, \"quantity\": quantityItem })\r\n            }\r\n            //prepare galons \r\n            let lenOfGalons = await retriveOrder.galons.length;\r\n            result.galons = [];\r\n            let resultGalons = retriveOrder.galons;\r\n            let resultGalonsQuantityOfBuying = retriveOrder.galonsQuantityOfBuying;\r\n            let resultGalonsQuantityOfSubstitution = retriveOrder.galonsQuantityOfSubstitution;\r\n            let resultGalonsTypeOrder = retriveOrder.galonsTypeOrder;\r\n            for (let x = 0; x < lenOfGalons; x++) {\r\n                let item = resultGalons[x];\r\n                let quantityOfBuying = resultGalonsQuantityOfBuying[x];\r\n                let quantityOfSubstitution = resultGalonsQuantityOfSubstitution[x];\r\n                result.galons.push({\r\n                    item: item,\r\n                    quantityOfBuying: quantityOfBuying,\r\n                    typeOrderOfSubstitution: quantityOfSubstitution\r\n                })\r\n            }\r\n            result.price = retriveOrder.price;\r\n            result.location = retriveOrder.location;\r\n            result.customer = retriveOrder.customer;\r\n            result.provider = retriveOrder.provider;\r\n            result.status = retriveOrder.status;\r\n            result.creationDate = retriveOrder.creationDate;\r\n            result.id = retriveOrder.id;\r\n            result.deliveryPrice = retriveOrder.deliveryPrice;\r\n\r\n\r\n            return res.status(201).json(result)\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n\r\n    },\r\n    //retrive all orders under specific provider \r\n    async allOrdersOfProvider(req, res, next) {\r\n        try {\r\n            const limit = parseInt(req.query.limit) || 20;\r\n            let page = req.query.page || 1;\r\n            let query = {}\r\n            if (req.query.status)\r\n                query.status = req.query.status;\r\n            query.provider = req.params.providerId;\r\n            let allOrders = await Order.find(query)\r\n                .populate('cartons')\r\n                .populate('galons')\r\n                .populate('customer')\r\n                .populate('provider')\r\n                .skip((page - 1) * limit).limit(limit)\r\n                .sort({ creationDate: -1 });\r\n            //prepare response \r\n            let result = allOrders.map(elme => {\r\n                //first prepare cartons\r\n                let OneOrderItem = {};\r\n                let cartonsResult = [];\r\n                let cartons = elme.cartons;\r\n                let cartonsQuantity = elme.cartonsQuantity;\r\n                for (let x = 0; x < cartons.length; x++) {\r\n                    let oneCartonItem = {};\r\n                    let item = cartons[x];\r\n                    let quantity = cartonsQuantity[x]\r\n                    oneCartonItem.item = item;\r\n                    oneCartonItem.quantity = quantity;\r\n                    cartonsResult.push(oneCartonItem);\r\n                }\r\n                //assign cartons result to order item \r\n                OneOrderItem.cartons = cartonsResult;\r\n                //prepare galons    \r\n                let galonsResult = [];\r\n                let galons = elme.galons;\r\n                let galonsQuantityOfBuying = elme.galonsQuantityOfBuying;\r\n                let galonsQuantityOfSubstitution = elme.galonsQuantityOfSubstitution;\r\n                for (let x = 0; x < galons.length; x++) {\r\n                    let oneGalonsItem = {};\r\n                    let item = galons[x];\r\n                    let QuantityOfBuying = galonsQuantityOfBuying[x]\r\n                    let QuantityOfSubstitution = galonsQuantityOfSubstitution[x]\r\n                    oneGalonsItem.item = item;\r\n                    oneGalonsItem.galonsQuantityOfBuying = QuantityOfBuying;\r\n                    oneGalonsItem.galonsQuantityOfSubstitution = QuantityOfSubstitution;\r\n                    galonsResult.push(oneGalonsItem);\r\n                }\r\n                //assign galons result to order item \r\n                OneOrderItem.galons = galonsResult;\r\n                OneOrderItem.location = elme.location;\r\n                OneOrderItem.customer = elme.customer;\r\n                OneOrderItem.provider = elme.provider;\r\n                OneOrderItem.status = elme.status;\r\n                OneOrderItem.creationDate = elme.creationDate;\r\n                OneOrderItem.id = elme.id;\r\n                OneOrderItem.price = elme.price;\r\n                OneOrderItem.deliveryPrice = elme.deliveryPrice\r\n                return OneOrderItem;\r\n            })\r\n            res.send(new ApiResponse(\r\n                result,\r\n                page,\r\n                Math.ceil((result.length) / limit),\r\n                limit,\r\n                result.length,\r\n                req\r\n            ))\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n\r\n    //validation input of calulate price \r\n    validateBodyOfCalulatePrice() {\r\n        return [\r\n            body(\"from\").exists().withMessage(\"from location is required\"),\r\n            body(\"to\").exists().withMessage(\"to location is required\")\r\n        ]\r\n    },\r\n    //calulate price of distance between provider and dilver location of order\r\n    async calculatePriceOfDistance(req, res, next) {\r\n        try {\r\n            const validationErrors = validationResult(req).array();\r\n            if (validationErrors.length > 0)\r\n                return next(new ApiError(422, validationErrors));\r\n            //first locattion point\r\n            let lang1 = parseFloat(req.body.from.lang);\r\n            let lat1 = parseFloat(req.body.from.lat);\r\n            //scound location point\r\n            let lang2 = parseFloat(req.body.to.lang);\r\n            let lat2 = parseFloat(req.body.to.lat);\r\n\r\n            let R = 6371; // Radius of the earth in km\r\n            let dLat = deg2rad(lat2 - lat1);  // deg2rad above\r\n            let dLon = deg2rad(lang2 - lang1);\r\n            let a =\r\n                Math.sin(dLat / 2) * Math.sin(dLat / 2) +\r\n                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *\r\n                Math.sin(dLon / 2) * Math.sin(dLon / 2);\r\n            let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n            let d = Math.ceil(R * c); // Distance in km\r\n            console.log(d);\r\n            //fetch price for each km\r\n            let price = await Price.findOne();\r\n            let cost = Math.ceil(d * price.price);\r\n\r\n            return res.status(200).json({\r\n                \"cost\": cost,\r\n                \"distance\": d,\r\n                \"priceOfEachKm\": price.price\r\n            });\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n    //retrive one order details\r\n    async orderDetails(req, res, next) {\r\n        let orderId = req.params.orderId;\r\n        try {\r\n            //prepare response    \r\n            let retriveOrder = await Order.findById(orderId)\r\n                .populate('cartons')\r\n                .populate('galons')\r\n                .populate('customer')\r\n                .populate('provider')\r\n            if (!retriveOrder)\r\n                return res.status(404).end()\r\n            let lenOfCartons = retriveOrder.cartons.length;\r\n            let result = {};\r\n            result.cartons = []\r\n            //prepare cartons \r\n            let resultcartons = retriveOrder.cartons;\r\n            let resultcartonsQuantity = retriveOrder.cartonsQuantity;\r\n            for (let x = 0; x < lenOfCartons; x++) {\r\n                let item = resultcartons[x];\r\n                let quantityItem = resultcartonsQuantity[x];\r\n                result.cartons.push({ \"item\": item, \"quantity\": quantityItem })\r\n            }\r\n            //prepare galons \r\n            let lenOfGalons = retriveOrder.galons.length;\r\n            result.galons = [];\r\n            let resultGalons = retriveOrder.galons;\r\n            let resultGalonsQuantityOfBuying = retriveOrder.galonsQuantityOfBuying;\r\n            let resultGalonsQuantityOfSubstitution = retriveOrder.galonsQuantityOfSubstitution;\r\n            let resultGalonsTypeOrder = retriveOrder.galonsTypeOrder;\r\n            for (let x = 0; x < lenOfGalons; x++) {\r\n                let item = resultGalons[x];\r\n                let quantityOfBuying = resultGalonsQuantityOfBuying[x];\r\n                let quantityOfSubstitution = resultGalonsQuantityOfSubstitution[x];\r\n                result.galons.push({\r\n                    \"item\": item,\r\n                    \"quantityOfBuying\": quantityOfBuying,\r\n                    \"typeOrderOfSubstitution\": quantityOfSubstitution\r\n                })\r\n            }\r\n            result.price = retriveOrder.price;\r\n            result.location = retriveOrder.location;\r\n            result.customer = retriveOrder.customer;\r\n            result.provider = retriveOrder.provider;\r\n            result.status = retriveOrder.status;\r\n            result.creationDate = retriveOrder.creationDate;\r\n            result.id = retriveOrder.id\r\n            result.deliveryPrice = retriveOrder.deliveryPrice;\r\n            return res.status(200).json(result)\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n    //accept order\r\n    async acceptOrder(req, res, next) {\r\n        let orderId = req.params.orderId;\r\n        try {\r\n            let orderDetails = await Order.findById(orderId);\r\n            if (!orderDetails)\r\n                return res.status(404).end();\r\n            let provider = orderDetails.provider;\r\n\r\n            if (!(provider == req.user.id))\r\n                return next(new ApiError(403, \"not access to this operation\"))\r\n\r\n            let newOrder = await Order.findByIdAndUpdate(orderId, { status: \"accepted\" }, { new: true });\r\n\r\n            //inApp notificattion \r\n            let newNoti = await NotificationOrder.create({\r\n                targetUser: newOrder.customer,\r\n                order: newOrder,\r\n                text: 'تم قبول طلبك بنجاح يمكنك الآن الاتصال بموفر الخدمة'\r\n            })\r\n            //send notification to client\r\n            let title = \"إشعار بشأن طلبك \";\r\n            let body = ' تم قبول طلبك بنجاح يمكنك الآن الاتصال بموفر الخدمة'\r\n            send(newOrder.customer, title, body)\r\n\r\n            console.log(newOrder.status)\r\n\r\n            return res.status(204).end();\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n    //refuse order by provider\r\n    async refuseOrder(req, res, next) {\r\n        let orderId = req.params.orderId;\r\n        try {\r\n\r\n            let orderDetails = await Order.findById(orderId);\r\n            if (!orderDetails)\r\n                return res.status(404).end();\r\n            let provider = orderDetails.provider;\r\n            if (!(provider == req.user.id))\r\n                return next(new ApiError(403, \"not access to this operation\"))\r\n            let newOrder = await Order.findByIdAndUpdate(orderId, { status: \"rejected\" }, { new: true });\r\n            console.log(newOrder.status)\r\n\r\n            //send notification to client\r\n            let title = \"إشعار بشأن طلبك\";\r\n            let body = ' نعتذر لعدم قبول طلبك';\r\n            send(newOrder.customer, title, body)\r\n\r\n            //inApp notification \r\n            let newNoti = await NotificationOrder.create({\r\n                targetUser: newOrder.customer,\r\n                order: newOrder,\r\n                text: 'نعتذر لعدم قبول طلبك'\r\n            })\r\n            return res.status(204).end();\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n    // make order ondiliver order \r\n    async makeOrderOnDiliver(req, res, next) {\r\n        let orderId = req.params.orderId;\r\n        try {\r\n\r\n            let orderDetails = await Order.findById(orderId);\r\n            if (!orderDetails)\r\n                return res.status(404).end();\r\n            let provider = orderDetails.provider;\r\n            if (!(provider == req.user.id))\r\n                return next(new ApiError(403, \"not access to this operation\"))\r\n            let newOrder = await Order.findByIdAndUpdate(orderId, { status: \"onTheWay\" }, { new: true });\r\n            //send notification to provider by completed order \r\n            let title = \"إشعار بشأن طلبك\";\r\n            let body = \"طلبك في الطريق إليك  يرجى الانتظار\"\r\n            send(newOrder.customer, title, body)\r\n            //inApp notification \r\n            let newNoti = await NotificationOrder.create({\r\n                targetUser: newOrder.customer,\r\n                order: newOrder.id,\r\n                text: 'طلبك في الطريق إليك  يرجى الانتظار'\r\n            })\r\n            console.log(newOrder.status)\r\n\r\n            return res.status(204).end();\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n    // make order done by user \r\n    async makeOrderDone(req, res, next) {\r\n        let orderId = req.params.orderId;\r\n        try {\r\n            let orderDetails = await Order.findById(orderId);\r\n            if (!orderDetails)\r\n                return res.status(404).end();\r\n            let customer = orderDetails.customer\r\n            if (!(customer == req.user.id))\r\n                return next(new ApiError(403, \"not access to this operation\"))\r\n            let newOrder = await Order.findByIdAndUpdate(orderId, { status: \"delivered\" }, { new: true });\r\n\r\n            //inApp notification \r\n            let newNoti = await NotificationOrder.create({\r\n                targetUser: newOrder.provider,\r\n                order: newOrder.id,\r\n                text: 'لقد تم اتمام الطلب بنجاح'\r\n            })\r\n\r\n            //send notification to provider by completed order \r\n            let body = 'لقد تم اتمام الطلب بنجاح';\r\n            let title = \"إشعار بشأن طلبك\"\r\n            send(orderDetails.provider, title, body)\r\n\r\n            console.log(newOrder.status)\r\n\r\n            return res.status(204).end();\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n\r\n    //reasone of refuse order \r\n    async sendReasoneOfRefuseOrder(req, res, next) {\r\n        try {\r\n            let orderId = req.params.orderId;\r\n            let orderDetails = await Order.findById(orderId);\r\n            if (!orderDetails)\r\n                return res.status(404).end();\r\n\r\n            orderDetails.note = req.body.note;\r\n            await orderDetails.save();\r\n\r\n            let newOrder = await Order.findById(orderId);\r\n\r\n            //inApp notification \r\n            let newNoti = await NotificationOrder.create({\r\n                targetUser: newOrder.customer,\r\n                order: newOrder.id,\r\n                text: newOrder.note\r\n            })\r\n\r\n            //send notification to provider by completed order \r\n            let body = newOrder.note;\r\n            let title = \"اعتذار لرفض الطلب\"\r\n            send(orderDetails.customer, title, body)\r\n            return res.status(204).end();\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n\r\n    //canceled order by customer \r\n    async canceleOrder(req, res, next) {\r\n        try {\r\n            let orderId = req.params.orderId;\r\n            let orderDetails = await Order.findById(orderId);\r\n            if (!orderDetails)\r\n                return res.status(404).end();\r\n            if (orderDetails.status == \"accepted\" || orderDetails.status == \"onTheWay\") {\r\n                return res.status(400).json({\r\n                    'message': \"can't cancel order now\"\r\n                })\r\n            }\r\n            let newOrder = await Order.findByIdAndUpdate(orderId, { status: \"canceled\" }, { new: true });\r\n            console.log(newOrder.status)\r\n            return res.status(204).end();\r\n\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n\r\n\r\n}"]}