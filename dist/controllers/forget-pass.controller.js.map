{"version":3,"sources":["../../src/controllers/forget-pass.controller.js"],"names":["forgetPassword","req","res","next","phone","body","findOne","userDetails","status","end","email","code","Math","floor","random","save","transporter","createTransport","service","auth","user","pass","mailOptions","from","to","subject","text","sendMail","error","info","console","log","json","matchCodeOfUserAndResetPass","newPassword","userCode","password"],"mappings":"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","file":"forget-pass.controller.js","sourcesContent":["import User from '../models/user.model';\r\nimport mongoose from 'mongoose';\r\nimport { body, validationResult } from 'express-validator/check';\r\nimport { toImgUrl } from '../utils/index'\r\nimport ApiError from '../helpers/ApiError'\r\nimport ApiResponse from '../helpers/ApiResponse'\r\nimport nodemailer from 'nodemailer'\r\n\r\n\r\nexport default {\r\n    async forgetPassword(req, res, next) {\r\n        try {\r\n            let phone = req.body.phone;\r\n            let userDetails = await User.findOne({ phone: phone });\r\n            if (!userDetails)\r\n                return res.status(404).end();\r\n            let email = userDetails.email;\r\n\r\n            //generate code \r\n            let code = Math.floor((Math.random() * 10000) + 1)\r\n            userDetails.code = code;\r\n            await userDetails.save();\r\n\r\n            //send email \r\n            let transporter = nodemailer.createTransport({\r\n                service: 'gmail',\r\n                auth: {\r\n                    user: 'rawaa.app@gmail.com',\r\n                    pass: 'rawaa123456789'\r\n                }\r\n            });\r\n\r\n            let mailOptions = {\r\n                from: 'rawaa.app@gmail.com',\r\n                to: `${email}`,\r\n                subject: 'Confirmation Code',\r\n                text: `Hello Dear, \r\n                Please use this code  ${code}  to reset your password\r\n                Thanks advanced`\r\n            }\r\n\r\n            transporter.sendMail(mailOptions, (error, info) => {\r\n                if (error)\r\n\r\n                    return console.log(error)\r\n                return res.status(200).json(info)\r\n            })\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n\r\n    //mach code \r\n    async matchCodeOfUserAndResetPass(req, res, next) {\r\n        try {\r\n            if (!req.body.code)\r\n                return next(new ApiError(422, 'code is required'))\r\n            let code = req.body.code;\r\n            if (!req.body.email)\r\n                return next(new ApiError(422, 'email is required'))\r\n            let email = req.body.email;\r\n            if (!req.body.newPassword)\r\n                return next(new ApiError(422, 'new password is required'))\r\n            console.log(email)\r\n            let userDetails = await User.findOne({ email: email });\r\n            console.log(userDetails)\r\n            if (!userDetails)\r\n                return res.status(404).end();\r\n\r\n            let userCode = userDetails.code;\r\n            if (!(code == userCode))\r\n                return res.status(400).json({\r\n                    \"message\": \"Invalid code\"\r\n                })\r\n            //change password    \r\n            userDetails.password = req.body.newPassword;\r\n            await userDetails.save();\r\n\r\n            return res.status(204).end();\r\n        } catch (err) {\r\n            next(err)\r\n        }\r\n    },\r\n\r\n\r\n\r\n}\r\n"]}